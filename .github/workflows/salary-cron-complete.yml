name: üí∞ Salary Forecast - Complete Cron Jobs

on:
  schedule:
    # 9h UTC = 10h CET (hiver) ou 11h CEST (√©t√©)
    - cron: '0 9 * * *'
  
  workflow_dispatch:
    inputs:
      task:
        description: 'Quelle t√¢che ex√©cuter?'
        required: true
        default: 'send-notifications'
        type: choice
        options:
          - send-notifications
          - health-check
          - all

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'send-notifications' || github.event.inputs.task == 'all' || github.event_name == 'schedule'
    
    steps:
      - name: üìã R√©cup√©rer le code
        uses: actions/checkout@v4
      
      - name: üí∞ Envoyer les notifications de salaire
        run: |
          echo "üöÄ D√©clenchement du cron job..."
          RESPONSE=$(curl -s -X GET '${{ secrets.APP_URL }}/api/cron/salary-notifications' \
            -H 'Authorization: Bearer ${{ secrets.CRON_SECRET }}' \
            -H 'Content-Type: application/json')
          
          echo "üìä R√©ponse:"
          echo "$RESPONSE" | jq '.'
          
          # Extraire le nombre de notifications envoy√©es
          SENT=$(echo "$RESPONSE" | jq '.result.sent // 0')
          FAILED=$(echo "$RESPONSE" | jq '.result.failed // 0')
          
          echo "‚úÖ Envoy√©es: $SENT"
          echo "‚ùå Erreurs: $FAILED"
          
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi
      
      - name: üìß Envoyer un email en cas d'erreur
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: ‚ùå Erreur - Cron job Pr√©visions Salariales
          to: ${{ secrets.ADMIN_EMAIL }}
          from: ${{ secrets.SMTP_FROM }}
          body: |
            Erreur lors de l'ex√©cution du cron job de pr√©visions salariales.
            
            D√©tails:
            - Repo: ${{ github.repository }}
            - Branch: ${{ github.ref }}
            - Commit: ${{ github.sha }}
            
            V√©rifiez les logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  health-check:
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'health-check' || github.event.inputs.task == 'all'
    
    steps:
      - name: üè• V√©rifier la sant√© de l'API
        run: |
          echo "üîç V√©rification de l'API..."
          
          # V√©rifier que l'API r√©pond
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" '${{ secrets.APP_URL }}/api/employees')
          
          echo "Status: $STATUS"
          
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ API accessible"
          else
            echo "‚ùå API non accessible (Status: $STATUS)"
            exit 1
          fi
      
      - name: üóÑÔ∏è V√©rifier la base de donn√©es
        run: |
          echo "üîç V√©rification de la base de donn√©es..."
          
          RESPONSE=$(curl -s '${{ secrets.APP_URL }}/api/salary-forecasts/statistics/test' \
            -H 'Authorization: Bearer ${{ secrets.CRON_SECRET }}')
          
          if echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            echo "‚úÖ BD accessible"
          else
            echo "‚ùå Erreur BD"
            exit 1
          fi

  notify-success:
    runs-on: ubuntu-latest
    needs: [send-notifications]
    if: success()
    
    steps:
      - name: üéâ Succ√®s
        run: |
          echo "‚úÖ Cron job ex√©cut√© avec succ√®s"
          echo "Les notifications de salaire ont √©t√© envoy√©es"

  notify-failure:
    runs-on: ubuntu-latest
    needs: [send-notifications]
    if: failure()
    
    steps:
      - name: üì¢ Alerte
        run: |
          echo "‚ùå Le cron job a √©chou√©"
          echo "Veuillez v√©rifier les logs"
