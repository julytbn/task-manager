generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id               String           @id @default(cuid())
  nom              String
  prenom           String
  email            String?
  telephone        String?
  entreprise       String?
  adresse          String?
  type             TypeClient       @default(PARTICULIER)
  gudefUrl         String?          // Lien GUDEF pour vérification entreprise
  dateNaissance    DateTime?
  siret            String?
  siren            String?
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  abonnements      Abonnement[]
  documents        DocumentClient[]
  factures         Facture[]
  paiements        Paiement[]
  proFormas        ProForma[]       @relation("ProFormasClient")
  projets          Projet[]
  souhaits         Souhait[]

  @@map("clients")
}

model DocumentClient {
  id          String   @id @default(cuid())
  nom         String
  description String?
  type        String?
  url         String
  clientId    String
  taille      Float?
  dateUpload  DateTime @default(now())
  uploadPar   String?
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("documents_clients")
}

model DocumentTache {
  id          String   @id @default(cuid())
  nom         String
  description String?
  type        String?
  url         String
  tacheId     String
  taille      Float?
  dateUpload  DateTime @default(now())
  uploadPar   String?
  tache       Tache    @relation(fields: [tacheId], references: [id], onDelete: Cascade)

  @@map("documents_taches")
}

model Service {
  id               String           @id @default(cuid())
  nom              String           @unique
  description      String?
  categorie        CategorieService
  prix             Float?
  dureeEstimee     Int?
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  abonnements      Abonnement[]
  projetServices   ProjetService[]
  taches           Tache[]

  @@map("services")
}

model Abonnement {
  id                       String            @id @default(cuid())
  nom                      String
  description              String?
  clientId                 String
  serviceId                String
  montant                  Float
  frequence                FrequencePaiement @default(MENSUEL)
  statut                   StatutAbonnement  @default(ACTIF)
  dateDebut                DateTime
  dateFin                  DateTime?
  dateProchainFacture      DateTime
  dernierPaiement          DateTime?
  notificationEnvoyee      Boolean           @default(false)
  nombrePaiementsEffectues Int               @default(0)
  dateCreation             DateTime          @default(now())
  dateModification         DateTime          @updatedAt
  client                   Client            @relation(fields: [clientId], references: [id])
  service                  Service           @relation(fields: [serviceId], references: [id])
  factures                 Facture[]

  @@map("abonnements")
}

model Projet {
  id               String          @id @default(cuid())
  titre            String
  description      String?
  clientId         String
  statut           StatutProjet    @default(EN_COURS)
  budget           Float?
  montantTotal     Float?
  dateDebut        DateTime?
  dateFin          DateTime?
  dateEcheance     DateTime?
  dateCreation     DateTime        @default(now())
  dateModification DateTime        @updatedAt
  equipeId         String?
  charges          Charge[]
  factures         Facture[]
  paiements        Paiement[]      @relation("PaiementsDuProjet")
  proFormas        ProForma[]      @relation("ProFormasProjet")
  projetServices   ProjetService[]
  client           Client          @relation(fields: [clientId], references: [id])
  equipe           Equipe?         @relation("ProjetAEquipe", fields: [equipeId], references: [id])
  taches           Tache[]
  timesheets       TimeSheet[]     @relation("TimesheetProjet")

  @@map("projets")
}

model ProjetService {
  id        String   @id @default(cuid())
  projetId  String
  serviceId String
  montant   Float?
  ordre     Int      @default(0)
  dateAjout DateTime @default(now())
  projet    Projet   @relation(fields: [projetId], references: [id], onDelete: Cascade)
  service   Service  @relation(fields: [serviceId], references: [id])

  @@unique([projetId, serviceId])
  @@map("projet_services")
}

model Tache {
  id               String          @id @default(cuid())
  titre            String
  description      String?
  projetId         String
  serviceId        String?
  assigneAId       String?
  creeParId        String?
  statut           StatutTache     @default(A_FAIRE)
  priorite         Priorite        @default(MOYENNE)
  dateEcheance     DateTime?
  heuresEstimees   Float?
  heuresReelles    Float?
  facturable       Boolean         @default(true)
  estPayee         Boolean         @default(false)
  montant          Float?
  dateCreation     DateTime        @default(now())
  dateModification DateTime        @updatedAt
  factureId        String?
  equipeId         String?
  commentaire      String?
  DocumentTache    DocumentTache[]
  paiements        Paiement[]
  assigneA         Utilisateur?    @relation("TacheAssignee", fields: [assigneAId], references: [id])
  creeePar         Utilisateur?    @relation("TacheCreatedBy", fields: [creeParId], references: [id])
  equipe           Equipe?         @relation("TacheEquipe", fields: [equipeId], references: [id])
  facture          Facture?        @relation(fields: [factureId], references: [id])
  projet           Projet          @relation(fields: [projetId], references: [id])
  service          Service?        @relation(fields: [serviceId], references: [id])
  timesheets       TimeSheet[]

  @@map("taches")
}

model TacheToDocumentTache {
  tacheId String
  docId   String

  @@id([tacheId, docId])
  @@map("_tache_to_document_tache")
}

model ProForma {
  id             String          @id @default(cuid())
  numero         String          @unique
  clientId       String
  projetId       String?
  montant        Float
  description    String?
  statut         StatutProForma  @default(EN_COURS)
  dateCreation   DateTime        @default(now())
  dateValidation DateTime?
  dateEcheance   DateTime?
  dateConversion DateTime?
  creePar        String?
  notes          String?
  lignes         ProFormaLigne[]
  client         Client          @relation("ProFormasClient", fields: [clientId], references: [id], onDelete: Cascade)
  projet         Projet?         @relation("ProFormasProjet", fields: [projetId], references: [id])

  @@unique([clientId, numero])
  @@index([statut])
  @@index([clientId])
  @@map("pro_formas")
}

model ProFormaLigne {
  id           String   @id @default(cuid())
  proFormaId   String
  designation  String
  montant      Float
  intervenant  String?
  ordre        Int      @default(0)
  dateCreation DateTime @default(now())
  proForma     ProForma @relation(fields: [proFormaId], references: [id], onDelete: Cascade)

  @@index([proFormaId])
  @@map("pro_forma_lignes")
}

model Facture {
  id                 String            @id @default(cuid())
  numero             String            @unique
  clientId           String
  projetId           String?
  statut             StatutFacture     @default(EN_ATTENTE)
  montant            Float
  montantEnLettres   String?
  dateEmission       DateTime          @default(now())
  dateEcheance       DateTime?
  datePaiement       DateTime?
  notes              String?
  description        String?
  conditionsPaiement String?
  valideeParId       String?
  dateValidation     DateTime?
  dateEnvoi          DateTime?
  reference          String?
  signatureUrl       String?
  dateCreation       DateTime          @default(now())
  dateModification   DateTime          @updatedAt
  abonnementId       String?
  documentsRequis    FactureDocument[]
  lignes             FactureLigne[]
  abonnement         Abonnement?       @relation(fields: [abonnementId], references: [id])
  client             Client            @relation(fields: [clientId], references: [id])
  projet             Projet?           @relation(fields: [projetId], references: [id])
  valideeParUser     Utilisateur?      @relation("FacturesValidees", fields: [valideeParId], references: [id])
  paiements          Paiement[]
  taches             Tache[]

  @@unique([abonnementId, dateEmission])
  @@index([statut])
  @@index([clientId])
  @@map("factures")
}

model FactureLigne {
  id               String   @id @default(cuid())
  factureId        String
  designation      String
  intervenant      String?
  montant          Float
  ordre            Int      @default(0)
  dateCreation     DateTime @default(now())
  dateModification DateTime @updatedAt
  facture          Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)

  @@index([factureId])
  @@map("facture_lignes")
}

model FactureDocument {
  id               String   @id @default(cuid())
  factureId        String
  nom              String
  obligatoire      Boolean  @default(true)
  notes            String?
  uploadedUrl      String?
  dateCreation     DateTime @default(now())
  dateModification DateTime @updatedAt
  facture          Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)

  @@index([factureId])
  @@map("facture_documents")
}

model Paiement {
  id                  String         @id @default(cuid())
  tacheId             String?
  projetId            String?
  clientId            String
  factureId           String
  montant             Float
  moyenPaiement       MoyenPaiement
  reference           String?
  datePaiement        DateTime       @default(now())
  dateReception       DateTime?
  statut              StatutPaiement @default(EN_ATTENTE)
  notes               String?
  preuvePaiement      String?
  dateCreation        DateTime       @default(now())
  dateModification    DateTime       @updatedAt
  datePaiementAttendu DateTime?
  notificationEnvoyee Boolean        @default(false)
  client              Client         @relation(fields: [clientId], references: [id])
  facture             Facture        @relation(fields: [factureId], references: [id])
  projet              Projet?        @relation("PaiementsDuProjet", fields: [projetId], references: [id])
  tache               Tache?         @relation(fields: [tacheId], references: [id])

  @@map("paiements")
}

model Utilisateur {
  id                   String                 @id @default(cuid())
  nom                  String
  prenom               String
  email                String                 @unique
  telephone            String?
  role                 RoleUtilisateur        @default(EMPLOYE)
  departement          String?
  tarifHoraire         Float?                 // Tarif horaire pour calcul des prévisions salariales
  actif                Boolean                @default(true)
  dateNaissance        DateTime?
  motDePasse           String?
  emailVerifie         DateTime?
  dateCreation         DateTime               @default(now())
  dateModification     DateTime               @updatedAt
  resetPasswordExpires DateTime?
  resetPasswordToken   String?                @unique
  charges              Charge[]               @relation("ChargesEmploye")
  equipesLead          Equipe[]               @relation("EquipeLeader")
  facturesValidees     Facture[]              @relation("FacturesValidees")
  membresEquipes       MembreEquipe[]
  notifications        Notification[]
  previsionsSalaires   PrevisionSalaire[]
  souhaits             Souhait[]
  tachesAssignees      Tache[]                @relation("TacheAssignee")
  tachesCreees         Tache[]                @relation("TacheCreatedBy")
  timesheets           TimeSheet[]            @relation("TimesheetEmploye")
  timesheetsValidees   TimeSheet[]            @relation("TimesheetValidatePar")

  @@map("utilisateurs")
}

model Equipe {
  id               String         @id @default(cuid())
  nom              String
  description      String?
  objectifs        String?
  dateEcheance     DateTime?
  leadId           String?
  dateCreation     DateTime       @default(now())
  dateModification DateTime       @updatedAt
  lead             Utilisateur?   @relation("EquipeLeader", fields: [leadId], references: [id])
  membres          MembreEquipe[]
  projets          Projet[]       @relation("ProjetAEquipe")
  taches           Tache[]        @relation("TacheEquipe")

  @@map("equipes")
}

model MembreEquipe {
  id            String      @id @default(cuid())
  equipeId      String
  utilisateurId String
  role          String?
  dateAjout     DateTime    @default(now())
  equipe        Equipe      @relation(fields: [equipeId], references: [id], onDelete: Cascade)
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@unique([equipeId, utilisateurId])
  @@map("membres_equipes")
}

model Notification {
  id               String           @id @default(cuid())
  utilisateurId    String
  titre            String
  message          String
  type             TypeNotification @default(INFO)
  lien             String?
  lu               Boolean          @default(false)
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  sourceId         String?
  sourceType       String?
  utilisateur      Utilisateur      @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@index([sourceId, utilisateurId, type])
  @@map("notifications")
}

model Souhait {
  id            String       @id @default(cuid())
  type          TypeSouhait
  message       String
  clientId      String?
  utilisateurId String?
  dateEnvoi     DateTime     @default(now())
  envoye        Boolean      @default(false)
  dateCreation  DateTime     @default(now())
  destinataire  Client?      @relation(fields: [clientId], references: [id])
  employe       Utilisateur? @relation(fields: [utilisateurId], references: [id])

  @@map("souhaits")
}

model EnumStatutTache {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_taches")
}

model EnumPriorite {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_priorites")
}

model EnumStatutProjet {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_projets")
}

model EnumCategorieService {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_categories_services")
}

model EnumTypeClient {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_types_clients")
}

model EnumStatutFacture {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_factures")
}

model EnumStatutPaiement {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_paiements")
}

model EnumMoyenPaiement {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_moyens_paiement")
}

model EnumTypeNotification {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_types_notifications")
}

model Charge {
  id               String          @id @default(cuid())
  montant          Float
  categorie        CategorieCharge
  description      String?
  date             DateTime        @default(now())
  projetId         String?
  employeId        String?
  justificatifUrl  String?
  notes            String?
  dateCreation     DateTime        @default(now())
  dateModification DateTime        @updatedAt
  employe          Utilisateur?    @relation("ChargesEmploye", fields: [employeId], references: [id])
  projet           Projet?         @relation(fields: [projetId], references: [id])

  @@index([categorie])
  @@index([date])
  @@index([projetId])
  @@map("charges")
}

model TimeSheet {
  id               String          @id @default(cuid())
  date             DateTime
  regularHrs       Int
  overtimeHrs      Int?
  sickHrs          Int?
  vacationHrs      Int?
  description      String?
  statut           StatutTimeSheet @default(EN_ATTENTE)
  employeeId       String
  taskId           String
  projectId        String
  dateCreation     DateTime        @default(now())
  dateModification DateTime        @updatedAt
  validePar        String?
  commentaire      String?         // Raison du rejet ou détails
  employee         Utilisateur     @relation("TimesheetEmploye", fields: [employeeId], references: [id])
  project          Projet          @relation("TimesheetProjet", fields: [projectId], references: [id], onDelete: Cascade)
  task             Tache           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  valideParUser    Utilisateur?    @relation("TimesheetValidatePar", fields: [validePar], references: [id])

  @@index([projectId])
  @@index([employeeId])
  @@index([date])
  @@map("timesheets")
}

model PrevisionSalaire {
  id               String   @id @default(cuid())
  employeId        String
  mois             Int
  annee            Int
  montantPrevu     Float
  montantNotifie   Float?   // Montant au moment de la dernière notification
  dateNotification DateTime? // Date d'envoi de la notification (5 jours avant)
  dateGeneration   DateTime @default(now())
  dateModification DateTime @updatedAt
  employe          Utilisateur @relation(fields: [employeId], references: [id], onDelete: Cascade)

  @@unique([employeId, mois, annee])
  @@index([employeId])
  @@index([mois, annee])
  @@map("previsions_salaires")
}

enum TypeClient {
  PARTICULIER
  ENTREPRISE
  ORGANISATION
}

enum CategorieService {
  COMPTABILITE
  AUDIT_FISCALITE
  MARKETING
  COMMUNICATION
  REDACTION_GESTION_PROJET
  DEMARRAGE_ADMINISTRATIF
  FORMATION
  COACHING
  ETUDE_MARCHE
  CONCEPTION_IMPRESSION
  IMMOBILIER
}

enum StatutProjet {
  PROPOSITION
  EN_ATTENTE
  EN_COURS
  TERMINE
  EN_RETARD
  ANNULE
}

enum StatutTache {
  A_FAIRE
  EN_COURS
  EN_REVISION
  SOUMISE
  TERMINE
  ANNULE
}

enum Priorite {
  BASSE
  MOYENNE
  HAUTE
  URGENTE
}

enum StatutFacture {
  BROUILLON
  EN_ATTENTE
  VALIDEE
  PARTIELLEMENT_PAYEE
  PAYEE
  RETARD
  ANNULEE
}

enum StatutPaiement {
  EN_ATTENTE
  CONFIRME
  REFUSE
  REMBOURSE
}

enum MoyenPaiement {
  ESPECES
  CHEQUE
  VIREMENT_BANCAIRE
  CARTE_BANCAIRE
  MOBILE_MONEY
  PAYPAL
  AUTRE
}

enum RoleUtilisateur {
  ADMIN
  MANAGER
  EMPLOYE
  CONSULTANT
}

enum TypeSouhait {
  ANNIVERSAIRE
  BONNE_ANNEE
  FETE
  AUTRE
}

enum TypeNotification {
  INFO
  EQUIPE
  TACHE
  ALERTE
  SUCCES
}

enum FrequencePaiement {
  PONCTUEL
  MENSUEL
  TRIMESTRIEL
  SEMESTRIEL
  ANNUEL
}

enum StatutAbonnement {
  ACTIF
  SUSPENDU
  EN_RETARD
  ANNULE
  TERMINE
}

enum CategorieCharge {
  SALAIRES_CHARGES_SOCIALES
  LOYER_IMMOBILIER
  UTILITIES
  MATERIEL_EQUIPEMENT
  TRANSPORT_DEPLACEMENT
  FOURNITURES_BUREAUTIQUE
  MARKETING_COMMUNICATION
  ASSURANCES
  TAXES_IMPOTS
  AUTRES_CHARGES
}

enum StatutTimeSheet {
  EN_ATTENTE
  VALIDEE
  REJETEE
  CORRIGEE
}

enum StatutProForma {
  EN_COURS
  ACCEPTEE
  REJETEE
  FACTUREE
  EXPIREE
}
