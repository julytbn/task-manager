generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id               String           @id @default(cuid())
  nom              String
  prenom           String
  email            String?
  telephone        String?
  entreprise       String?
  adresse          String?
  type             TypeClient       @default(PARTICULIER)
  dateNaissance    DateTime?
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  abonnements      Abonnement[]
  documents        DocumentClient[]
  factures         Facture[]
  paiements        Paiement[]
  projets          Projet[]
  devis            Devis[]
  souhaits         Souhait[]

  @@map("clients")
}

model DocumentClient {
  id          String   @id @default(cuid())
  nom         String
  description String?
  type        String?
  url         String
  clientId    String
  taille      Float?
  dateUpload  DateTime @default(now())
  uploadPar   String?
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("documents_clients")
}

model DocumentTache {
  id          String   @id @default(cuid())
  nom         String
  description String?
  type        String?
  url         String
  tacheId     String
  taille      Float?
  dateUpload  DateTime @default(now())
  uploadPar   String?
  tache       Tache    @relation(fields: [tacheId], references: [id], onDelete: Cascade)

  @@map("documents_taches")
}

model Service {
  id               String           @id @default(cuid())
  nom              String           @unique
  description      String?
  categorie        CategorieService
  prix             Float?
  dureeEstimee     Int?
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  abonnements      Abonnement[]
  taches           Tache[]
  projetServices   ProjetService[]
  devisServices    DevisService[]   @relation("ServicesInDevis")

  @@map("services")
}

model Abonnement {
  id                       String            @id @default(cuid())
  nom                      String
  description              String?
  clientId                 String
  serviceId                String
  montant                  Float
  frequence                FrequencePaiement @default(MENSUEL)
  statut                   StatutAbonnement  @default(ACTIF)
  dateDebut                DateTime
  dateFin                  DateTime?
  dateProchainFacture      DateTime
  dernierPaiement          DateTime?
  notificationEnvoyee      Boolean           @default(false)
  nombrePaiementsEffectues Int               @default(0)
  dateCreation             DateTime          @default(now())
  dateModification         DateTime          @updatedAt
  client                   Client            @relation(fields: [clientId], references: [id])
  service                  Service           @relation(fields: [serviceId], references: [id])
  factures                 Facture[]

  @@map("abonnements")
}

model Projet {
  id                String            @id @default(cuid())
  titre             String
  description       String?
  clientId          String
  statut            StatutProjet      @default(EN_COURS)
  budget            Float?
  montantTotal      Float?            // Total réel = sum(projetServices.montant)
  dateDebut         DateTime?
  dateFin           DateTime?
  dateEcheance      DateTime?
  devisId           String?           // Optionnel : lié à un devis validé
  dateCreation      DateTime          @default(now())
  dateModification  DateTime          @updatedAt
  equipeId          String?
  factures          Facture[]
  paiements         Paiement[]        @relation("PaiementsDuProjet")
  client            Client            @relation(fields: [clientId], references: [id])
  equipe            Equipe?           @relation("ProjetAEquipe", fields: [equipeId], references: [id])
  devis             Devis?            @relation("DevisAuProjet", fields: [devisId], references: [id], onDelete: SetNull)
  projetServices    ProjetService[]
  taches            Tache[]
  charges           Charge[]
  timesheets        TimeSheet[]       @relation("TimesheetProjet")

  @@map("projets")
}

model ProjetService {
  id        String   @id @default(cuid())
  projetId  String
  serviceId String
  montant   Float?   // Montant du service DANS ce projet (peut différer du prix catalogue)
  ordre     Int      @default(0)
  dateAjout DateTime @default(now())
  
  projet    Projet   @relation(fields: [projetId], references: [id], onDelete: Cascade)
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  @@unique([projetId, serviceId])
  @@map("projet_services")
}

model Tache {
  id               String          @id @default(cuid())
  titre            String
  description      String?
  projetId         String
  serviceId        String?
  assigneAId       String?
  creeParId        String?
  statut           StatutTache     @default(A_FAIRE)
  priorite         Priorite        @default(MOYENNE)
  dateEcheance     DateTime?
  heuresEstimees   Float?
  heuresReelles    Float?
  facturable       Boolean         @default(true)
  estPayee         Boolean         @default(false)
  montant          Float?
  dateCreation     DateTime        @default(now())
  dateModification DateTime        @updatedAt
  factureId        String?
  equipeId         String?
  commentaire      String?
  DocumentTache    DocumentTache[]
  paiements        Paiement[]
    timesheets       TimeSheet[]
  assigneA         Utilisateur?    @relation("TacheAssignee", fields: [assigneAId], references: [id])
  creeePar         Utilisateur?    @relation("TacheCreatedBy", fields: [creeParId], references: [id])
  equipe           Equipe?         @relation("TacheEquipe", fields: [equipeId], references: [id])
  facture          Facture?        @relation(fields: [factureId], references: [id])
  projet           Projet          @relation(fields: [projetId], references: [id])
  service          Service?        @relation(fields: [serviceId], references: [id])

  @@map("taches")
}

model TacheToDocumentTache {
  tacheId String
  docId   String

  @@id([tacheId, docId])
  @@map("_tache_to_document_tache")
}

model Facture {
  id               String        @id @default(cuid())
  numero           String        @unique
  clientId         String
  projetId         String?
  statut           StatutFacture @default(EN_ATTENTE)
  montant          Float
  tauxTVA          Float         @default(0.18)
  montantTotal     Float
  dateEmission     DateTime      @default(now())
  dateEcheance     DateTime?
  datePaiement     DateTime?
  notes            String?
  dateCreation     DateTime      @default(now())
  dateModification DateTime      @updatedAt
  abonnementId     String?
  abonnement       Abonnement?   @relation(fields: [abonnementId], references: [id])
  client           Client        @relation(fields: [clientId], references: [id])
  projet           Projet?       @relation(fields: [projetId], references: [id])
  paiements        Paiement[]
  taches           Tache[]

  @@unique([abonnementId, dateEmission])
  @@map("factures")
}

model Paiement {
  id                  String         @id @default(cuid())
  tacheId             String?
  projetId            String?
  clientId            String
  factureId           String
  montant             Float
  moyenPaiement       MoyenPaiement
  reference           String?
  datePaiement        DateTime       @default(now())
  dateReception       DateTime?
  statut              StatutPaiement @default(EN_ATTENTE)
  notes               String?
  preuvePaiement      String?
  dateCreation        DateTime       @default(now())
  dateModification    DateTime       @updatedAt
  datePaiementAttendu DateTime?
  notificationEnvoyee Boolean        @default(false)
  client              Client         @relation(fields: [clientId], references: [id])
  facture             Facture        @relation(fields: [factureId], references: [id])
  projet              Projet?        @relation("PaiementsDuProjet", fields: [projetId], references: [id])
  tache               Tache?         @relation(fields: [tacheId], references: [id])

  @@map("paiements")
}

model Utilisateur {
  id                   String          @id @default(cuid())
  nom                  String
  prenom               String
  email                String          @unique
  telephone            String?
  role                 RoleUtilisateur @default(EMPLOYE)
  departement          String?
  actif                Boolean         @default(true)
  dateNaissance        DateTime?
  motDePasse           String?
  emailVerifie         DateTime?
  dateCreation         DateTime        @default(now())
  dateModification     DateTime        @updatedAt
  resetPasswordExpires DateTime?
  resetPasswordToken   String?         @unique
  equipesLead          Equipe[]        @relation("EquipeLeader")
  membresEquipes       MembreEquipe[]
  notifications        Notification[]
  souhaits             Souhait[]
  tachesAssignees      Tache[]         @relation("TacheAssignee")
  tachesCreees         Tache[]         @relation("TacheCreatedBy")
  timesheets           TimeSheet[]     @relation("TimesheetEmploye")
  timesheetsValidees   TimeSheet[]     @relation("TimesheetValidatePar")
  charges              Charge[]        @relation("ChargesEmploye")

  @@map("utilisateurs")
}

model Equipe {
  id               String         @id @default(cuid())
  nom              String
  description      String?
  objectifs        String?
  dateEcheance     DateTime?
  leadId           String?
  dateCreation     DateTime       @default(now())
  dateModification DateTime       @updatedAt
  lead             Utilisateur?   @relation("EquipeLeader", fields: [leadId], references: [id])
  membres          MembreEquipe[]
  projets          Projet[]       @relation("ProjetAEquipe")
  taches           Tache[]        @relation("TacheEquipe")

  @@map("equipes")
}

model MembreEquipe {
  id            String      @id @default(cuid())
  equipeId      String
  utilisateurId String
  role          String?
  dateAjout     DateTime    @default(now())
  equipe        Equipe      @relation(fields: [equipeId], references: [id], onDelete: Cascade)
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@unique([equipeId, utilisateurId])
  @@map("membres_equipes")
}

model Notification {
  id               String           @id @default(cuid())
  utilisateurId    String
  titre            String
  message          String
  type             TypeNotification @default(INFO)
  lien             String?
  lu               Boolean          @default(false)
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  sourceId         String?
  sourceType       String?
  utilisateur      Utilisateur      @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@index([sourceId, utilisateurId, type])
  @@map("notifications")
}

model Souhait {
  id            String       @id @default(cuid())
  type          TypeSouhait
  message       String
  clientId      String?
  utilisateurId String?
  dateEnvoi     DateTime     @default(now())
  envoye        Boolean      @default(false)
  dateCreation  DateTime     @default(now())
  destinataire  Client?      @relation(fields: [clientId], references: [id])
  employe       Utilisateur? @relation(fields: [utilisateurId], references: [id])

  @@map("souhaits")
}

model EnumStatutTache {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_taches")
}

model EnumPriorite {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_priorites")
}

model EnumStatutProjet {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_projets")
}

model EnumCategorieService {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_categories_services")
}

model EnumTypeClient {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_types_clients")
}

model EnumStatutFacture {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_factures")
}

model EnumStatutPaiement {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_statuts_paiements")
}

model EnumMoyenPaiement {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_moyens_paiement")
}

model EnumTypeNotification {
  id    String  @id @default(cuid())
  cle   String  @unique
  label String
  ordre Int     @default(0)
  actif Boolean @default(true)

  @@map("enum_types_notifications")
}

// ============================================
// NOUVEAUX MODÈLES : Devis, Charge, TimeSheet
// ============================================

model Devis {
  id            String          @id @default(cuid())
  numero        String          @unique
  clientId      String
  titre         String?
  description   String?
  montant       Float
  tauxTVA       Float           @default(0.18)
  montantTotal  Float
  statut        StatutDevis     @default(BROUILLON)
  dateCreation  DateTime        @default(now())
  dateEnvoi     DateTime?
  dateAccept    DateTime?
  dateRefus     DateTime?
  notes         String?
  dateModification DateTime      @updatedAt
  
  client        Client          @relation(fields: [clientId], references: [id])
  services      DevisService[]
  projets       Projet[]        @relation("DevisAuProjet")

  @@index([clientId])
  @@index([statut])
  @@map("devis")
}

model DevisService {
  id        String    @id @default(cuid())
  devisId   String
  serviceId String
  quantite  Int       @default(1)
  prix      Float?
  dateAjout DateTime  @default(now())
  
  devis     Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  service   Service   @relation("ServicesInDevis", fields: [serviceId], references: [id], onDelete: Restrict)

  @@unique([devisId, serviceId])
  @@map("devis_services")
}

model Charge {
  id              String            @id @default(cuid())
  montant         Float
  categorie       CategorieCharge
  description     String?
  date            DateTime          @default(now())
  projetId        String?
  employeId       String?
  justificatifUrl String?
  notes           String?
  dateCreation    DateTime          @default(now())
  dateModification DateTime          @updatedAt
  
  projet          Projet?           @relation(fields: [projetId], references: [id], onDelete: SetNull)
  employe         Utilisateur?      @relation("ChargesEmploye", fields: [employeId], references: [id], onDelete: SetNull)

  @@index([categorie])
  @@index([date])
  @@index([projetId])
  @@map("charges")
}

model TimeSheet {
  id              String            @id @default(cuid())
  date            DateTime
  regularHrs      Int               // heures normales
  overtimeHrs     Int?              // heures supplémentaires
  sickHrs         Int?              // maladie
  vacationHrs     Int?              // congés
  description     String?
  statut          StatutTimeSheet   @default(EN_ATTENTE)
  employeeId      String
  taskId          String
  projectId       String
  dateCreation    DateTime          @default(now())
  dateModification DateTime          @updatedAt
  validePar       String?           // ID du manager qui valide
  
  employee        Utilisateur       @relation("TimesheetEmploye", fields: [employeeId], references: [id])
  task            Tache             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project         Projet            @relation("TimesheetProjet", fields: [projectId], references: [id], onDelete: Cascade)
  valideParUser   Utilisateur?      @relation("TimesheetValidatePar", fields: [validePar], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([employeeId])
  @@index([date])
  @@map("timesheets")
}

enum TypeClient {
  PARTICULIER
  ENTREPRISE
  ORGANISATION
}

enum CategorieService {
  COMPTABILITE
  AUDIT_FISCALITE
  MARKETING
  COMMUNICATION
  REDACTION_GESTION_PROJET
  DEMARRAGE_ADMINISTRATIF
  FORMATION
  COACHING
  ETUDE_MARCHE
  CONCEPTION_IMPRESSION
  IMMOBILIER
}

enum StatutProjet {
  PROPOSITION
  EN_ATTENTE
  EN_COURS
  TERMINE
  EN_RETARD
  ANNULE
}

enum StatutTache {
  A_FAIRE
  EN_COURS
  EN_REVISION
  SOUMISE
  TERMINE
  ANNULE
}

enum Priorite {
  BASSE
  MOYENNE
  HAUTE
  URGENTE
}

enum StatutFacture {
  BROUILLON
  EN_ATTENTE
  PARTIELLEMENT_PAYEE
  PAYEE
  RETARD
  ANNULEE
}

enum StatutPaiement {
  EN_ATTENTE
  CONFIRME
  REFUSE
  REMBOURSE
}

enum MoyenPaiement {
  ESPECES
  CHEQUE
  VIREMENT_BANCAIRE
  CARTE_BANCAIRE
  MOBILE_MONEY
  PAYPAL
  AUTRE
}

enum RoleUtilisateur {
  ADMIN
  MANAGER
  EMPLOYE
  CONSULTANT
}

enum TypeSouhait {
  ANNIVERSAIRE
  BONNE_ANNEE
  FETE
  AUTRE
}

enum TypeNotification {
  INFO
  EQUIPE
  TACHE
  ALERTE
  SUCCES
}

enum FrequencePaiement {
  PONCTUEL
  MENSUEL
  TRIMESTRIEL
  SEMESTRIEL
  ANNUEL
}

enum StatutAbonnement {
  ACTIF
  SUSPENDU
  EN_RETARD
  ANNULE
  TERMINE
}

enum StatutDevis {
  BROUILLON
  ENVOYE
  ACCEPTE
  REFUSE
  ANNULE
}

enum CategorieCharge {
  SALAIRES_CHARGES_SOCIALES
  LOYER_IMMOBILIER
  UTILITIES
  MATERIEL_EQUIPEMENT
  TRANSPORT_DEPLACEMENT
  FOURNITURES_BUREAUTIQUE
  MARKETING_COMMUNICATION
  ASSURANCES
  TAXES_IMPOTS
  AUTRES_CHARGES
}

enum StatutTimeSheet {
  EN_ATTENTE
  VALIDEE
  REJETEE
  CORRIGEE
}

